<!DOCTYPE HTML>
<html lang="en-GB">
<head>

<!-- Technical meta -->
<base target="_blank">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, shrink-to-fit=no, maximum-scale=1.0, user-scalable=no">

<!-- Search engine meta -->
<title>Threecap Tryout</title>
<meta name="description"
      content="A basic tryout of threecap">
<link rel="author" href="README.md">

<!-- Threecap and Scene styles -->
<link rel="stylesheet" type="text/css" href="css/threecapui.css">
<style>
  body { margin: 0; }
  canvas { width:1920px; height:1080px }
</style>

</head>
<body>

<h1>Threecap Tryout</h1>
<h4>A basic tryout of <a href="https://github.com/jbaicoianu/threecap">threecap</a></h4>
<p>
  <a href="https://github.com/richplastow/threecap-tryout">Repo</a> &nbsp;
  <a href="http://richplastow.com/threecap-tryout/">Demo</a>
</p>

<!-- Load the data -->
<script>
  window.registerData = function (data) {
      window.worldcities = data
  }
</script>
<script src="data/worldcities.js"></script>

<!-- THREE.js -->
<script src="js/three.min.js"></script>

<!-- THREE.js postprocessing -->
<script src="js/EffectComposer.js"></script>
<script src="js/ShaderPass.js"></script>
<script src="js/MaskPass.js"></script>
<script src="js/RenderPass.js"></script>

<!-- THREE.js shaders -->
<script src="js/CopyShader.js"></script>
<script src="js/RGBShiftShader.js"></script>

<!-- Threecap -->
<script src="threecap-master/build/threecap.js"></script>

<!-- Create and animate the scene -->
<script>!function (ROOT) {

    //// Init...
    const
        width = 1920 // ROOT.innerWidth
      , height = 1080 // ROOT.innerHeight
      , pixelRatio = ROOT.devicePixelRatio || 0

    //// ...THREE objects...
	  , clock = new THREE.Clock()
      , scene = new THREE.Scene()
      , camera = new THREE.PerspectiveCamera(35, width/height, 0.1, 1000)
      , renderer = new THREE.WebGLRenderer({ antialias:true })
	  , composer = new THREE.EffectComposer(renderer)
	  // , rgbShiftEffect = new THREE.ShaderPass(THREE.RGBShiftShader)
	  , copyEffect = new THREE.ShaderPass(THREE.CopyShader)


      , globe = new THREE.Object3D()
      , textureLoader = new THREE.TextureLoader()
      , texture = textureLoader.load('img/circle-transparent.png')
      , material = new THREE.SpriteMaterial({
            map: texture
          , color:0xffffff
          , blending: THREE.AdditiveBlending
          , depthTest: false
          , transparent: true
          , fog:true
        })
      , sprites = []

    // material.color.setHSL(1.0, 0.2, 0.5)

    // Init Threecap.
    // const threecap = new THREEcap()
    // threecap.record({
    //     width: 640
    //   , height: 480
    //   , fps: 25
    //   , time: 10
    //   , format: 'mp4'
    //   , canvas: renderer.domElement // optional, slowest
    //   //  , composer: composer // optional, fastest
    //   , scriptbase: 'threecap-master/build/'
    // }).then(function(video) {
    //     video.saveFile('myVideo.mp4');
    // })
	const capture = new THREEcap({
        // canvas: renderer.domElement // optional, slowest
        composer: composer
      , scriptbase: 'threecap-master/build/'
    })
	const captureui = new THREEcapUI(capture)


    //// Set up the scene.
	renderer.setPixelRatio(pixelRatio)
    renderer.setSize(width, height)
    composer.setSize(width * pixelRatio, height * pixelRatio)
	renderer.autoClear = false
	composer.addPass( new THREE.RenderPass(scene, camera) )
	// rgbShiftEffect.uniforms.amount.value = 0.0015
    // rgbShiftEffect.renderToScreen = true
	// composer.addPass(rgbShiftEffect)
    copyEffect.renderToScreen = false
	composer.addPass(copyEffect)

    document.body.appendChild(renderer.domElement)
    scene.add(globe)
    globe.rotation.x = - Math.PI / 2
    globe.rotation.z = Math.PI // start above India
    // globe.rotation.z = Math.PI
	scene.fog = new THREE.FogExp2(0x000080, 0.004)
    camera.position.z = 300

    //// Add a circle sprite for every item in the data.
    for (let i=1; i<window.worldcities.length; i++) { // i=1, ignore header line
        const sprite = new THREE.Sprite(material)
        const [ pop, city, x, y, z ] = window.worldcities[i]
        sprite.position.set(x, y, z)
        sprite.scale.set(2,2,2)
        sprites.push(sprite)
        globe.add(sprite)
    }


    //// Renders the scene.
    function animate() {
    	requestAnimationFrame(animate)
		const delta = clock.getDelta()
        globe.rotation.z += (0.05 / 25) * delta
		renderer.clear()
		composer.render(0.01)
    }

    //// Begin Rendering.
    animate()

}(this)</script>

</body>
</html>
